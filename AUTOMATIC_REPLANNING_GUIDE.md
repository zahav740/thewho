# Автоматическое перепланирование после наладки

## Обзор

В приложении TheWho реализована функциональность автоматического перепланирования производственных операций после ввода фактического времени наладки. Это позволяет корректировать планы производства на основе реальных данных и поддерживать актуальность расписания.

## Как это работает

### 1. Завершение наладки операции

Пользователь может отметить наладку как завершенную через:
- **Дашборд планирования** → **Планируемые операции** → **Редактировать** → **Отметить наладку как выполненную**

### 2. Ввод фактического времени наладки

- Открывается модальное окно `SetupCompletionModal`
- Пользователь вводит фактическое время наладки в минутах
- Показывается разница с плановым временем и процентное отклонение
- Отображается предупреждение о предстоящем автоматическом перепланировании

### 3. Автоматическое перепланирование

После сохранения фактического времени наладки система автоматически:

#### Обновляет текущую операцию:
- Устанавливает фактическое время наладки
- Пересчитывает время окончания операции
- Меняет статус на "выполняется" (`in-progress`)

#### Перепланирует последующие операции:
- Находит все запланированные операции на том же станке
- Пересчитывает время начала каждой операции с учетом:
  - Нового времени окончания текущей операции
  - Зависимостей между операциями в рамках заказа
  - Ограничений планирования (макс. 2 операции в день, правило 14:00)
  - Рабочих дней и израильского календаря
- Обновляет расписание только для затронутого станка

#### Создает записи в системе:
- **Алерт** о выполненном перепланировании
- **Запись в журнале** перепланирований с детальной информацией
- **Проверка дедлайнов** и создание новых алертов при необходимости

## Ограничения и правила планирования

### Ограничения по станкам:
- **Максимум 2 операции** на станок в день
- **Правило 14:00**: если операция заканчивается до 14:00, больше операций в этот день не назначается
- **Рабочие дни**: учитываются выходные и праздники Израиля

### Зависимости операций:
- Операции выполняются в порядке, определенном номером операции
- Последующая операция не может начаться до завершения предыдущей
- Перепланирование учитывает эти зависимости

## Журнал перепланирований

### Доступ к журналу:
**Дашборд планирования** → **Журнал перепланирований**

### Информация в журнале:
- **Триггерная операция**: какая операция вызвала перепланирование
- **Изменение времени наладки**: плановое vs фактическое время
- **Затронутые операции**: список перенесенных операций
- **Статистика воздействия**: количество операций, максимальная задержка
- **Временные метки**: когда произошло перепланирование

## Аналитика перепланирований

### Статистическая карточка включает:
- **Общее количество** перепланирований
- **Количество затронутых** операций
- **Среднюю и максимальную** задержки
- **Отклонение времени наладки** (в процентах)
- **Наиболее затронутый станок**
- **Активность за неделю** с индикатором уровня

### Доступ к статистике:
**Дашборд планирования** → **Аналитика** → **Статистика перепланирований**

## Технические детали

### Ключевые компоненты:

1. **SetupCompletionModal** - UI для ввода фактического времени наладки
2. **ProductionPlanner.markSetupCompleted()** - основная логика перепланирования
3. **useProductionPlanning.markSetupCompleted()** - хук для обработки в React
4. **RescheduleLogModal** - просмотр журнала перепланирований
5. **RescheduleStatsCard** - статистика перепланирований

### Алгоритм перепланирования:

```typescript
async markSetupCompleted(resultId, actualSetupTime, existingResults, allOrders) {
  // 1. Обновить текущую операцию с фактическим временем наладки
  // 2. Найти все операции на том же станке, требующие перепланирования
  // 3. Для каждой операции:
  //    - Определить новое время начала
  //    - Проверить зависимости от предыдущих операций
  //    - Найти доступный слот с учетом ограничений
  //    - Пересчитать время окончания
  // 4. Создать журналирование и алерты
  // 5. Вернуть обновленные результаты
}
```

### Хранение данных:

- **Планирование**: `localStorage['planningResults']`
- **Алерты**: `localStorage['planningAlerts']`
- **Журнал перепланирований**: `localStorage['rescheduleLog']`

## Преимущества системы

### 1. Автоматизация:
- Не требует ручного перепланирования
- Мгновенное обновление всех зависимых операций
- Автоматическое соблюдение всех ограничений планирования

### 2. Точность:
- Использование фактических данных вместо плановых
- Учет реальных времен наладки для будущего планирования
- Каскадное обновление всех затронутых операций

### 3. Прозрачность:
- Полная история всех перепланирований
- Детальная аналитика влияния изменений
- Визуальные индикаторы отклонений

### 4. Гибкость:
- Возможность ручной корректировки после автоматического перепланирования
- Настройка ограничений планирования
- Интеграция с календарной системой

## Использование в производстве

### Рекомендуемый workflow:

1. **Планирование** производства на основе оценочных времен
2. **Выполнение** операций с отметкой фактических времен наладки
3. **Автоматическое перепланирование** для поддержания актуальности
4. **Мониторинг** через аналитику для улучшения будущих оценок
5. **Анализ** журнала для выявления паттернов отклонений

### Лучшие практики:

- **Своевременный ввод** фактических времен наладки
- **Регулярный мониторинг** алертов о нарушении дедлайнов
- **Анализ статистики** отклонений для улучшения планирования
- **Использование данных** из журнала для корректировки оценок

## Заключение

Система автоматического перепланирования значительно повышает точность и актуальность производственного планирования, минимизируя ручную работу и человеческие ошибки. Интеграция с системой алертов и аналитикой обеспечивает полный контроль над процессом планирования производства.
