# 🚀 Установка Enhanced Calendar System

## Обзор изменений

Улучшенная система календаря решает все выявленные проблемы:

### ✅ Что исправлено:
- ✅ **Правильные рабочие дни**: Пятница-суббота теперь выходные
- ✅ **Расчет продолжительности**: Операции рассчитываются в рабочих днях  
- ✅ **Детализация смен**: Показывает дневные/ночные смены отдельно
- ✅ **Исторические данные**: Отображает выполненный объем по прошедшим дням
- ✅ **Время наладки**: Показывает наладку для дневных смен (🔧)
- ✅ **Эффективность**: Рассчитывает и показывает эффективность операторов

### 📊 Данные в календаре:
- **Название станка** - код и тип обработки
- **Общее количество** - деталей за дневную (☀️) и ночную (🌙) смены
- **Наладка** - время наладки отображается значком 🔧
- **Эффективность** - процент выполнения плана по времени
- **Продолжительность** - расчет в рабочих днях

## 🛠 Инструкция по установке

### 1. Backend изменения

#### 1.1 Добавление новых сервисов
Файлы уже созданы:
- `backend/src/modules/calendar/enhanced-calendar.service.ts`
- `backend/src/modules/calendar/enhanced-calendar.controller.ts`

#### 1.2 Обновление модуля календаря
Файл `backend/src/modules/calendar/calendar.module.ts` уже обновлен.

### 2. Frontend изменения

#### 2.1 Новые компоненты
Файлы созданы:
- `frontend/src/services/enhancedCalendarApi.ts`
- `frontend/src/pages/Calendar/components/EnhancedProductionCalendar.tsx`
- `frontend/src/pages/Calendar/EnhancedCalendarPage.tsx`

#### 2.2 Обновленный CalendarPage
Файл `frontend/src/pages/Calendar/CalendarPage.tsx` обновлен с переключателем версий.

### 3. База данных

#### 3.1 Выполните SQL скрипт
```bash
# Подключитесь к вашей базе PostgreSQL
psql -h localhost -U postgres -d thewho

# Выполните скрипт
\i enhanced_calendar_setup.sql
```

#### 3.2 Что создается:
- `working_days_settings` - настройки рабочих дней
- `working_time_templates` - шаблоны смен  
- `operation_planning` - планирование операций
- `calendar_events` - события календаря
- Функции расчета рабочих дней
- Тестовые данные

### 4. Запуск системы

#### 4.1 Backend
```bash
cd backend
npm run start:dev
```

#### 4.2 Frontend  
```bash
cd frontend
npm start
```

### 5. Проверка работы

1. Откройте страницу **Календарь** в CRM
2. Увидите уведомление о новой версии календаря
3. По умолчанию загружается **Enhanced календарь**
4. Переключитесь между версиями кнопкой в правом верхнем углу

## 🎯 Как использовать Enhanced календарь

### Основные возможности:

1. **Выходные дни**: Пятница-суббота автоматически отмечены как выходные 🏖️
2. **Детализация смен**: 
   - ☀️ Дневная смена (8:00-16:00)
   - 🌙 Ночная смена (20:00-04:00)
3. **Наладка**: Отображается значком 🔧 для дневных смен
4. **Эффективность**: Цветовые индикаторы от красного до зеленого
5. **Tooltip**: Наведите курсор на ячейку для детальной информации

### Настройки отображения:

- **Показывать выходные** - включить/выключить выходные дни
- **Показывать эффективность** - показатели эффективности операторов  
- **Показывать наладку** - время наладки
- **Режим отображения** - детализированный/компактный

### Цветовая схема:

- 🟢 **Зеленый** - высокая эффективность (>90%)
- 🔵 **Синий** - хорошая эффективность (75-90%)
- 🟡 **Желтый** - средняя эффективность (60-75%)
- 🔴 **Красный** - низкая эффективность (<60%)

## 📈 API эндпоинты

### Новые эндпоинты Enhanced календаря:

```
GET /api/calendar/enhanced
GET /api/calendar/enhanced/working-days  
GET /api/calendar/enhanced/operation-duration
GET /api/calendar/enhanced/machine-summary
```

### Примеры запросов:

```bash
# Получить календарь
curl "http://localhost:5100/api/calendar/enhanced?startDate=2025-06-11&endDate=2025-06-25"

# Рассчитать рабочие дни
curl "http://localhost:5100/api/calendar/enhanced/working-days?startDate=2025-06-11&endDate=2025-06-25"

# Рассчитать продолжительность операции
curl "http://localhost:5100/api/calendar/enhanced/operation-duration?timePerPart=20&quantity=100&setupTime=120"
```

## 🔧 Кастомизация

### Изменение рабочих дней:
```sql
-- Обновить паттерн рабочих дней для 2025 года
UPDATE working_days_settings 
SET working_days_pattern = '1111100' -- Понедельник-пятница рабочие
WHERE year = 2025;
```

### Добавление праздников:
```sql
-- Добавить праздники
UPDATE working_days_settings 
SET holidays = ARRAY['2025-01-01', '2025-05-01', '2025-12-25', '2025-06-12']
WHERE year = 2025;
```

### Настройка времени смен:
```sql
-- Обновить рабочее время
UPDATE working_time_templates 
SET day_shift_start = '07:00', day_shift_end = '15:00'
WHERE name = 'Стандартный (2 смены)';
```

## 🎉 Готово!

Enhanced Calendar System установлен и готов к использованию!

**Основные преимущества:**
- ✅ Правильный расчет рабочих дней (пятница-суббота выходные)
- ✅ Детализация по сменам с операторами и эффективностью
- ✅ Отображение времени наладки
- ✅ Расчет продолжительности операций в рабочих днях
- ✅ Исторические данные по прошедшим дням
- ✅ Современный интерфейс с tooltip'ами

Теперь ваш календарь показывает всю необходимую информацию для эффективного планирования производства! 🚀
