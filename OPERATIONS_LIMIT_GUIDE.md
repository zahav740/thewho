# Ограничения количества операций на станок

## Обзор изменений

Добавлены ограничения на количество операций, которые могут быть запланированы на одном станке в день.

### Новые правила планирования

**Ограничение 1: Максимум 2 операции на станок в день**
- Каждый станок может выполнять не более 2 операций в рабочий день
- При попытке назначить третью операцию на станок в тот же день, система автоматически переносит её на следующий рабочий день

**ОГРАНИЧЕНИЕ 2: Блокировка дня при раннем окончании операции**
- Если операция заканчивается до 14:00, то на этот станок больше не назначаются операции на этот день
- Это предотвращает короткие операции в конце дня и обеспечивает лучшее использование времени
- Проверка происходит на уровне календарной даты (не 24 часа)

### Технические детали

#### Изменения в коде

Файл: `src/utils/productionPlanning.ts`

**Добавлена проверка в метод `findAvailableTimeSlot`:**

```typescript
// Проверяем количество операций в день (максимум 2)
const candidateDate = candidateStart.toDateString();
const operationsInDay = schedule.filter(slot => {
  return slot.start.toDateString() === candidateDate;
}).length;

// НОВОЕ ОГРАНИЧЕНИЕ: Максимум 2 операции на станок в день
if (operationsInDay >= 2) {
  console.log(`⚠️ Станок ${machineName} уже имеет ${operationsInDay} операций на ${candidateDate}. Переходим к следующему дню.`);
  // Переходим к следующему рабочему дню
  candidateStart = await this.getNextWorkingDayStart(candidateStart);
  iterations++;
  continue;
}
```

**Добавлен вспомогательный метод `getNextWorkingDayStart`:**

```typescript
private async getNextWorkingDayStart(currentDate: Date): Promise<Date> {
  const nextDay = new Date(currentDate);
  nextDay.setDate(nextDay.getDate() + 1);
  nextDay.setHours(8, 0, 0, 0);
  
  const nextWorkingDay = await IsraeliCalendar.getNextWorkingDay(nextDay);
  nextWorkingDay.setHours(8, 0, 0, 0);
  
  return nextWorkingDay;
}
```

### Логика работы

1. **Подсчет операций**: При поиске времени для новой операции система подсчитывает количество уже запланированных операций на данном станке в кандидатурный день

2. **Проверка лимита**: Если в день уже запланированы 2 операции, система автоматически переходит к поиску слота в следующем рабочем дне

3. **Переход к следующему дню**: Используется метод `getNextWorkingDayStart`, который учитывает израильский календарь (выходные и праздники)

4. **Логирование**: В консоль выводятся сообщения о применении ограничения для отслеживания

### Влияние на планирование

#### Положительные эффекты:
- **Предотвращение перегрузки** станков в один день
- **Более равномерное распределение** работы по дням
- **Снижение риска** задержек из-за проблем с наладкой
- **Улучшение качества** выполнения операций

#### Возможные последствия:
- **Увеличение сроков** выполнения некоторых заказов
- **Необходимость более раннего планирования** для соблюдения дедлайнов
- **Повышенные требования** к точности оценки времени операций

### Исключения и особые случаи

- Ограничение применяется на уровне календарных дней (00:00 - 23:59)
- Не учитывается длительность операций - важно только их количество
- Операции, которые начинаются в один день и заканчиваются в другой, считаются операциями дня начала

### Мониторинг и отчетность

В логах консоли можно увидеть:
- Предупреждения о превышении лимита операций на день
- Информацию о найденных свободных слотах с указанием количества операций в день

Пример лога:
```
⚠️ Станок Doosan Hadasha уже имеет 2 операций на Tue May 20 2025. Переходим к следующему дню.
✅ Найден свободный слот на станке Doosan Hadasha на Wed May 21 2025. Всего операций в этот день: 1
```

### Рекомендации

1. **Планирование заранее**: Учитывайте новое ограничение при установке дедлайнов заказов

2. **Балансировка нагрузки**: При необходимости можно будет рассмотреть возможность изменения лимита на 3 операции для некоторых станков

3. **Мониторинг эффективности**: Отслеживайте влияние ограничения на общие сроки выполнения заказов

4. **Настройка приоритетов**: Более точно устанавливайте приоритеты заказов, чтобы важные задачи получали приоритет в планировании

### Будущие улучшения

- Возможность настраивать лимит операций для каждого станка индивидуально
- Учет сложности операций (простые операции могут разрешаться в большем количестве)
- Интеллектуальное планирование с предварительным анализом загрузки станков

---

**Примечание**: Это ограничение вступает в силу немедленно для всех новых планирований. Существующие планы остаются без изменений до следующего перепланирования.
