# Руководство по настройке и управлению данными в Supabase

Это руководство содержит информацию о настройке и управлении данными в облачной базе данных Supabase для приложения TheWho.

## Содержание
1. [Введение](#введение)
2. [Первоначальная настройка](#первоначальная-настройка)
3. [Структура данных](#структура-данных)
4. [Управление данными](#управление-данными)
5. [Резервное копирование](#резервное-копирование)
6. [Безопасность](#безопасность)
7. [Устранение неисправностей](#устранение-неисправностей)

## Введение

Supabase используется в приложении TheWho для:
- Хранения данных о заказах и операциях
- Сохранения результатов планирования
- Хранения PDF-файлов чертежей
- Обеспечения доступа к данным из разных устройств

## Первоначальная настройка

### Создание аккаунта и проекта

1. Зарегистрируйтесь на [supabase.com](https://supabase.com/)
2. Создайте новый проект
3. В настройках проекта найдите URL проекта и анонимный API ключ
4. Скопируйте эти значения в файл `.env` вашего приложения:
   ```
   VITE_SUPABASE_URL=https://einfkyyhsutvtipocjtg.supabase.co
   VITE_SUPABASE_KEY=your-anon-key
   ```

### Настройка базы данных

1. Выполните SQL-скрипт из файла `docs/supabase_sql_schema.sql` в SQL-редакторе Supabase
2. Скрипт создаст необходимые таблицы и индексы
3. Настройте политики доступа как описано в файле `docs/pdf_storage_setup.md`

## Структура данных

База данных содержит следующие основные таблицы:

### Таблица orders

Содержит информацию о заказах:
- `id`: Уникальный идентификатор заказа
- `drawing_number`: Номер чертежа
- `deadline`: Дедлайн выполнения заказа
- `quantity`: Количество единиц в заказе
- `priority`: Приоритет заказа
- `pdf_url`: Ссылка на PDF-файл чертежа (если есть)
- `created_at`: Дата создания записи
- `updated_at`: Дата последнего обновления

### Таблица operations

Содержит информацию об операциях для каждого заказа:
- `id`: Уникальный идентификатор операции
- `order_id`: Идентификатор заказа (внешний ключ)
- `sequence_number`: Порядковый номер операции
- `machine`: Назначенный станок
- `operation_type`: Тип операции (3-axis, 4-axis, turning, milling)
- `estimated_time`: Расчетное время выполнения
- `completed_units`: Количество выполненных единиц
- `actual_time`: Фактическое время выполнения
- `status`: Статус операции (pending, in-progress, completed)
- `operators`: Массив операторов, выполняющих операцию

### Таблица planning

Содержит результаты планирования операций:
- `id`: Уникальный идентификатор записи планирования
- `order_id`: Идентификатор заказа
- `operation_id`: Идентификатор операции
- `machine`: Назначенный станок
- `planned_start_date`: Запланированная дата и время начала
- `planned_end_date`: Запланированная дата и время окончания
- `quantity_assigned`: Назначенное количество
- `remaining_quantity`: Оставшееся количество
- `expected_time_minutes`: Ожидаемое время выполнения (минуты)
- `setup_time_minutes`: Время наладки (минуты)
- `buffer_time_minutes`: Буферное время (минуты)
- `status`: Статус планирования (planned, in-progress, completed, rescheduled)

## Управление данными

### Синхронизация данных

Используйте компонент Supabase Sync в приложении для:
1. **Отправки данных в Supabase**: Нажмите кнопку "Синхронизировать в Supabase" для отправки всех локальных данных в облако
2. **Загрузки данных из Supabase**: Нажмите кнопку "Загрузить из Supabase" для получения всех данных из облака

### Работа с PDF-файлами

При загрузке PDF-файлов через приложение:
1. Файл автоматически загружается в бакет `pdf_files` в Supabase
2. URL файла сохраняется в поле `pdf_url` соответствующего заказа
3. Для просмотра файла используется встроенный просмотрщик PDF

### Ручное редактирование данных

Для прямого доступа к данным в Supabase:
1. Войдите в панель управления Supabase
2. Выберите "Table Editor" в левом меню
3. Выберите нужную таблицу
4. Используйте интерфейс для просмотра, добавления, редактирования или удаления записей

## Резервное копирование

### Экспорт данных

1. В панели управления Supabase выберите "SQL Editor"
2. Создайте запрос для экспорта данных, например:
   ```sql
   SELECT * FROM orders;
   SELECT * FROM operations;
   SELECT * FROM planning;
   ```
3. Выполните запрос и экспортируйте результаты в CSV-файл через кнопку "Download"

### Экспорт PDF-файлов

1. В панели управления Supabase выберите "Storage" -> "Buckets" -> "pdf_files"
2. Используйте интерфейс для скачивания отдельных файлов
3. Для массового скачивания используйте Supabase CLI или Storage API

## Безопасность

### Управление API-ключами

1. Никогда не публикуйте API-ключи в публичных репозиториях
2. Используйте переменные окружения для хранения ключей
3. Периодически обновляйте API-ключи в настройках Supabase

### Политики доступа

1. Регулярно проверяйте и обновляйте политики доступа
2. Ограничивайте доступ к таблицам только аутентифицированными пользователями
3. Используйте Row Level Security (RLS) для более детального контроля доступа

## Устранение неисправностей

### Проблемы с синхронизацией

Если возникают ошибки при синхронизации:
1. Проверьте консоль браузера для деталей ошибки
2. Убедитесь, что API-ключ и URL проекта указаны верно
3. Проверьте, что таблицы созданы с правильной структурой
4. Проверьте политики доступа к таблицам

### Проблемы с PDF-файлами

Если PDF-файлы недоступны:
1. Проверьте, что файлы присутствуют в бакете `pdf_files`
2. Убедитесь, что установлены правильные политики доступа для бакета
3. Проверьте, что URL файла правильно сохранен в базе данных
4. Проверьте квоты хранилища в настройках Supabase

### Логирование

Для диагностики проблем используйте логирование:
1. В панели управления Supabase выберите "Logs" в левом меню
2. Просмотрите логи запросов и ошибок
3. Для более детального логирования добавьте `console.log` выводы в код приложения

### Поддержка

Если проблемы не решаются:
1. Обратитесь к [документации Supabase](https://supabase.com/docs)
2. Задайте вопрос на форуме [GitHub Discussions](https://github.com/supabase/supabase/discussions)
3. Обратитесь в [поддержку Supabase](https://supabase.com/support)
