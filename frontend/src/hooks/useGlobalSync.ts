/**
 * @file: useGlobalSync.ts
 * @description: Ð¥ÑƒÐº Ð´Ð»Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°Ð¼Ð¸
 * @dependencies: react-query
 * @created: 2025-06-12
 */
import { useQueryClient } from '@tanstack/react-query';
import { useCallback, useEffect } from 'react';
import { message } from 'antd';
import { QUERY_KEYS, invalidateOperationRelatedQueries, forceRefreshCriticalData } from '../utils/queryKeys';

interface GlobalSyncOptions {
  /**
   * Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ…
   */
  enableAutoSync?: boolean;
  
  /**
   * Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ (Ð² Ð¼Ñ)
   */
  forceRefreshInterval?: number;
  
  /**
   * ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
   */
  showNotifications?: boolean;
}

export const useGlobalSync = (options: GlobalSyncOptions = {}) => {
  const queryClient = useQueryClient();
  
  const {
    enableAutoSync = true,
    forceRefreshInterval = 10000, // 10 ÑÐµÐºÑƒÐ½Ð´
    showNotifications = false
  } = options;

  /**
   * Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
   */
  const syncAfterPlanning = useCallback(async () => {
    console.log('ðŸ”„ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸...');
    
    if (showNotifications) {
      message.loading('Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…...', 1);
    }
    
    // Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸
    invalidateOperationRelatedQueries(queryClient);
    
    // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· ÑÐµÐºÑƒÐ½Ð´Ñƒ
    setTimeout(() => {
      forceRefreshCriticalData(queryClient);
      
      if (showNotifications) {
        message.success('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÐºÑ†Ð¸ÑÐ¼Ð¸', 2);
      }
    }, 1000);
    
    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð´Ð»Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸
    setTimeout(() => {
      queryClient.refetchQueries({ queryKey: QUERY_KEYS.MACHINES_AVAILABILITY });
      queryClient.refetchQueries({ queryKey: QUERY_KEYS.OPERATIONS_IN_PROGRESS });
    }, 3000);
    
  }, [queryClient, showNotifications]);

  /**
   * Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¼ÐµÐ½
   */
  const syncShifts = useCallback(() => {
    console.log('ðŸ”„ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¼ÐµÐ½...');
    
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.SHIFTS });
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.SHIFTS_TODAY });
    
    // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
    setTimeout(() => {
      queryClient.refetchQueries({ queryKey: QUERY_KEYS.SHIFTS_TODAY });
    }, 500);
    
  }, [queryClient]);

  /**
   * ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
   */
  const fullSync = useCallback(() => {
    console.log('ðŸš€ ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²...');
    
    if (showNotifications) {
      message.loading('ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ...', 2);
    }
    
    // Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ð’Ð¡Ð• ÐºÐ»ÑŽÑ‡Ð¸
    Object.values(QUERY_KEYS).forEach(key => {
      if (Array.isArray(key)) {
        queryClient.invalidateQueries({ queryKey: key });
      }
    });
    
    // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
    setTimeout(() => {
      forceRefreshCriticalData(queryClient);
      
      if (showNotifications) {
        message.success('ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°', 3);
      }
    }, 1000);
    
  }, [queryClient, showNotifications]);

  /**
   * ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°
   */
  const forceRefreshComponent = useCallback((component: 'production' | 'shifts' | 'both') => {
    console.log(`ðŸ”„ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°: ${component}`);
    
    switch (component) {
      case 'production':
        queryClient.refetchQueries({ queryKey: QUERY_KEYS.MACHINES });
        queryClient.refetchQueries({ queryKey: QUERY_KEYS.OPERATIONS });
        break;
        
      case 'shifts':
        queryClient.refetchQueries({ queryKey: QUERY_KEYS.MACHINES_AVAILABILITY });
        queryClient.refetchQueries({ queryKey: QUERY_KEYS.OPERATIONS_IN_PROGRESS });
        queryClient.refetchQueries({ queryKey: QUERY_KEYS.SHIFTS_TODAY });
        break;
        
      case 'both':
        forceRefreshCriticalData(queryClient);
        break;
    }
  }, [queryClient]);

  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹
  useEffect(() => {
    if (enableAutoSync && forceRefreshInterval > 0) {
      const interval = setInterval(() => {
        console.log('â° ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ');
        forceRefreshCriticalData(queryClient);
      }, forceRefreshInterval);
      
      return () => clearInterval(interval);
    }
  }, [enableAutoSync, forceRefreshInterval, queryClient]);

  return {
    syncAfterPlanning,
    syncShifts,
    fullSync,
    forceRefreshComponent,
  };
};

export default useGlobalSync;
