/**
 * @file: MachineCard.enhanced.tsx
 * @description: Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ MachineCard Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¾Ğ¹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
 * @created: 2025-06-15
 */

// ĞĞĞ’Ğ«Ğ™ Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ•ĞĞĞ«Ğ™ ĞĞ›Ğ“ĞĞ Ğ˜Ğ¢Ğœ Ğ¡ĞĞŸĞĞ¡Ğ¢ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ¡ Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞĞ™
const operationProgress = React.useMemo(() => {
  console.log(`ğŸ” === Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ”Ğ›Ğ¯ Ğ¡Ğ¢ĞĞĞšĞ ${machine.machineName} ===`);
  
  if (!machine.currentOperationDetails || !todayShifts) {
    console.log(`ğŸš« ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:`, {
      hasOperation: !!machine.currentOperationDetails,
      hasShifts: !!todayShifts,
      shiftsLength: todayShifts?.length || 0
    });
    return null;
  }

  console.log(`ğŸ“Š Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:`);
  console.log(`   Ğ¡Ñ‚Ğ°Ğ½Ğ¾Ğº ID: ${machine.id} (Ñ‚Ğ¸Ğ¿: ${typeof machine.id})`);
  console.log(`   ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ: ${machine.currentOperationDetails.orderDrawingNumber}`);
  console.log(`   Ğ’ÑĞµĞ³Ğ¾ ÑĞ¼ĞµĞ½: ${todayShifts.length}`);

  // Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑĞ¼ĞµĞ½Ñ‹
  console.log(`ğŸ“‹ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ²ÑĞµÑ… ÑĞ¼ĞµĞ½:`);
  todayShifts.forEach((shift: any, index: number) => {
    console.log(`   Ğ¡Ğ¼ĞµĞ½Ğ° ${index + 1} (ID: ${shift.id}):`);
    console.log(`     machineId: ${shift.machineId} (Ñ‚Ğ¸Ğ¿: ${typeof shift.machineId})`);
    console.log(`     drawingNumber: "${shift.drawingNumber}"`);
    console.log(`     orderDrawingNumber: "${shift.orderDrawingNumber}"`);
    console.log(`     operationId: ${shift.operationId}`);
    console.log(`     Ğ´Ğ°Ñ‚Ğ°: ${shift.date}`);
    console.log(`     Ğ´ĞµĞ½ÑŒ: ${shift.dayShiftQuantity}, Ğ½Ğ¾Ñ‡ÑŒ: ${shift.nightShiftQuantity}`);
  });

  // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ñ‹ ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
  console.log(`ğŸ¯ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¾Ğ² ÑĞ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:`);

  // ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 1: ĞŸĞ¾ ID ÑÑ‚Ğ°Ğ½ĞºĞ° + Ñ‡ĞµÑ€Ñ‚ĞµĞ¶
  const algorithm1Results = todayShifts.filter((shift: any) => {
    const shiftMachineId = parseInt(shift.machineId?.toString() || '0');
    const currentMachineId = parseInt(machine.id?.toString() || '0');
    const machineMatches = shiftMachineId === currentMachineId;

    const shiftDrawing = (shift.drawingNumber || shift.orderDrawingNumber || '').toString().trim();
    const operationDrawing = (machine.currentOperationDetails?.orderDrawingNumber || '').toString().trim();
    const drawingMatches = shiftDrawing === operationDrawing;

    console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 1 - Ğ¡Ğ¼ĞµĞ½Ğ° ${shift.id}:`);
    console.log(`     Ğ¡Ñ‚Ğ°Ğ½Ğ¾Ğº: ${shiftMachineId} === ${currentMachineId} â†’ ${machineMatches}`);
    console.log(`     Ğ§ĞµÑ€Ñ‚ĞµĞ¶: "${shiftDrawing}" === "${operationDrawing}" â†’ ${drawingMatches}`);
    console.log(`     Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: ${machineMatches && drawingMatches}`);

    return machineMatches && drawingMatches;
  });

  // ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 2: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ ID ÑÑ‚Ğ°Ğ½ĞºĞ°
  const algorithm2Results = todayShifts.filter((shift: any) => {
    const shiftMachineId = parseInt(shift.machineId?.toString() || '0');
    const currentMachineId = parseInt(machine.id?.toString() || '0');
    const matches = shiftMachineId === currentMachineId;

    console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 2 - Ğ¡Ğ¼ĞµĞ½Ğ° ${shift.id}: ${shiftMachineId} === ${currentMachineId} â†’ ${matches}`);
    return matches;
  });

  // ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 3: ĞŸĞ¾ operationId (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
  const algorithm3Results = todayShifts.filter((shift: any) => {
    if (!shift.operationId || !machine.currentOperationId) return false;
    
    const shiftOpId = shift.operationId?.toString();
    const machineOpId = machine.currentOperationId?.toString();
    const matches = shiftOpId === machineOpId;

    console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 3 - Ğ¡Ğ¼ĞµĞ½Ğ° ${shift.id}: "${shiftOpId}" === "${machineOpId}" â†’ ${matches}`);
    return matches;
  });

  // ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 4: Ğ“Ğ¸Ğ±ĞºĞ¸Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ñ‡ĞµÑ€Ñ‚ĞµĞ¶Ñƒ (Ğ±ĞµĞ· ÑƒÑ‡ĞµÑ‚Ğ° ÑÑ‚Ğ°Ğ½ĞºĞ°)
  const algorithm4Results = todayShifts.filter((shift: any) => {
    const shiftDrawing = (shift.drawingNumber || shift.orderDrawingNumber || '').toString().trim();
    const operationDrawing = (machine.currentOperationDetails?.orderDrawingNumber || '').toString().trim();
    
    if (!shiftDrawing || !operationDrawing) return false;
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑƒÑ„Ñ„Ğ¸ĞºÑÑ‹ Ğ¸ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼
    const normalizedShift = shiftDrawing.replace(/-TEST$/i, '').toUpperCase();
    const normalizedOperation = operationDrawing.replace(/-TEST$/i, '').toUpperCase();
    const matches = normalizedShift === normalizedOperation;

    console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 4 - Ğ¡Ğ¼ĞµĞ½Ğ° ${shift.id}: "${normalizedShift}" === "${normalizedOperation}" â†’ ${matches}`);
    return matches;
  });

  console.log(`ğŸ“ˆ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¾Ğ²:`);
  console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 1 (ÑÑ‚Ğ°Ğ½Ğ¾Ğº + Ñ‡ĞµÑ€Ñ‚ĞµĞ¶): ${algorithm1Results.length} ÑĞ¼ĞµĞ½`);
  console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 2 (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ°Ğ½Ğ¾Ğº): ${algorithm2Results.length} ÑĞ¼ĞµĞ½`);
  console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 3 (operationId): ${algorithm3Results.length} ÑĞ¼ĞµĞ½`);
  console.log(`   ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ 4 (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€Ñ‚ĞµĞ¶): ${algorithm4Results.length} ÑĞ¼ĞµĞ½`);

  // Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
  let matchedShifts: any[] = [];
  let usedAlgorithm = 'none';

  if (algorithm1Results.length > 0) {
    matchedShifts = algorithm1Results;
    usedAlgorithm = 'ÑÑ‚Ğ°Ğ½Ğ¾Ğº + Ñ‡ĞµÑ€Ñ‚ĞµĞ¶';
  } else if (algorithm3Results.length > 0) {
    matchedShifts = algorithm3Results;
    usedAlgorithm = 'operationId';
  } else if (algorithm4Results.length > 0) {
    matchedShifts = algorithm4Results;
    usedAlgorithm = 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€Ñ‚ĞµĞ¶';
  } else if (algorithm2Results.length > 0) {
    matchedShifts = algorithm2Results;
    usedAlgorithm = 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ°Ğ½Ğ¾Ğº';
  }

  console.log(`ğŸ¯ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼: "${usedAlgorithm}"`);
  console.log(`âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${matchedShifts.length} Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… ÑĞ¼ĞµĞ½`);

  if (matchedShifts.length === 0) {
    console.log(`âŒ ĞĞ• ĞĞĞ™Ğ”Ğ•ĞĞ Ğ¡ĞĞ’ĞŸĞĞ”Ğ•ĞĞ˜Ğ™ - ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ Ğ’ Ğ”ĞĞĞĞ«Ğ¥ Ğ˜Ğ›Ğ˜ ĞĞ›Ğ“ĞĞ Ğ˜Ğ¢ĞœĞ•`);
    console.log(`ğŸ”§ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:`);
    console.log(`   1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ machineId Ğ² ÑĞ¼ĞµĞ½Ğ°Ñ… Ğ¸ ÑÑ‚Ğ°Ğ½ĞºĞ°Ñ…`);
    console.log(`   2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ñ‡ĞµÑ€Ñ‚ĞµĞ¶ĞµĞ¹`);
    console.log(`   3. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ operationId Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ² ÑĞ¼ĞµĞ½Ğ°Ñ…`);
    console.log(`   4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (ÑÑ‚Ñ€Ğ¾ĞºĞ¸ vs Ñ‡Ğ¸ÑĞ»Ğ°)`);
  }

  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¼ĞµĞ½
  const totalProduced = matchedShifts.reduce((sum: number, shift: any) => {
    const dayShift = shift.dayShiftQuantity || 0;
    const nightShift = shift.nightShiftQuantity || 0;
    const total = dayShift + nightShift;
    console.log(`ğŸ“Š Ğ¡Ğ¼ĞµĞ½Ğ° ${shift.id}: ${dayShift} + ${nightShift} = ${total}`);
    return sum + total;
  }, 0);

  const targetQuantity = 30;
  const percentage = Math.min((totalProduced / targetQuantity) * 100, 100);

  const result = {
    completedParts: totalProduced,
    totalParts: targetQuantity,
    percentage: Math.round(percentage),
    isCompleted: totalProduced >= targetQuantity,
    startedAt: matchedShifts.length > 0 ? new Date(matchedShifts[0].date) : null,
    dayShiftQuantity: matchedShifts.reduce((sum: number, shift: any) => sum + (shift.dayShiftQuantity || 0), 0),
    nightShiftQuantity: matchedShifts.reduce((sum: number, shift: any) => sum + (shift.nightShiftQuantity || 0), 0),
    dayShiftOperator: matchedShifts.find((shift: any) => shift.dayShiftOperator)?.dayShiftOperator || '-',
    nightShiftOperator: matchedShifts.find((shift: any) => shift.nightShiftOperator)?.nightShiftOperator || 'ĞÑ€ĞºĞ°Ğ´Ğ¸Ğ¹',
    // Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
    _debug: {
      usedAlgorithm,
      matchedShiftsCount: matchedShifts.length,
      matchedShiftIds: matchedShifts.map(s => s.id),
      totalShiftsAnalyzed: todayShifts.length
    }
  };

  console.log(`ğŸ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:`, result);
  console.log(`ğŸ” === ĞšĞĞĞ•Ğ¦ Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ˜ ===`);

  return result;
}, [machine.currentOperationDetails, machine.id, todayShifts]);
