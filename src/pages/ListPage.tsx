import { useState, useEffect } from 'react';
import { Search, Upload, Edit, Trash2 } from 'lucide-react';
import { useTranslation } from 'react-i18next';
import { useApp } from '../context/AppContext';
import OrderForm from '../components/OrderForm';
import EditOrderModal from '../components/EditOrderModal';
import SupabaseSync from '../components/SupabaseSync';
import { Order } from '../types';
import * as XLSX from 'xlsx';

export default function ListPage() {
  const { t } = useTranslation();
  const { orders, addOrder, deleteOrder } = useApp();
  const [searchQuery, setSearchQuery] = useState('');
  const [showImportModal, setShowImportModal] = useState(false);
  const [editingOrder, setEditingOrder] = useState<Order | null>(null);
  const [showBulkDeleteModal, setShowBulkDeleteModal] = useState(false);
  const [selectedOrderIds, setSelectedOrderIds] = useState<Set<string>>(new Set());
  const [contextMenu, setContextMenu] = useState<{ x: number; y: number } | null>(null);
  const [columnMappings, setColumnMappings] = useState({
    drawingNumber: '',
    deadline: '',
    quantity: '',
    priority: ''
  });
  const [excelData, setExcelData] = useState<any[]>([]);
  const [excelHeaders, setExcelHeaders] = useState<string[]>([]);
  const [originalExcelData, setOriginalExcelData] = useState<any[]>([]);
  const [colorFilter, setColorFilter] = useState<'all' | 'exclude_green' | 'only_green'>('all');
  const [cellColors, setCellColors] = useState<Map<string, string>>(new Map());
  const [detectedColors, setDetectedColors] = useState<string[]>([]);
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —è—á–µ–π–∫–∏
  const getCellColor = (worksheet: any, row: number, col: number): string | null => {
    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
    const cell = worksheet[cellAddress];
    
    if (!cell) return null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª–∏ —è—á–µ–π–∫–∏
    if (cell.s) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º fill (–∑–∞–ª–∏–≤–∫–∞/—Ñ–æ–Ω)
      if (cell.s.fill) {
        if (cell.s.fill.fgColor) {
          // RGB —Ü–≤–µ—Ç
          if (cell.s.fill.fgColor.rgb) {
            const rgb = cell.s.fill.fgColor.rgb;
            return rgb.startsWith('#') ? rgb : `#${rgb}`;
          }
          // –ò–Ω–¥–µ–∫—Å–Ω—ã–π —Ü–≤–µ—Ç
          if (cell.s.fill.fgColor.indexed !== undefined) {
            const colorMap: Record<number, string> = {
              10: '#00FF00', // —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π
              11: '#00FF00', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
              43: '#92D050', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
              50: '#00B050', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
              35: '#00B050', // –∑–µ–ª–µ–Ω—ã–π
              42: '#00AC4A', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
              51: '#C6E0B4', // –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
              3: '#FF0000',  // –∫—Ä–∞—Å–Ω—ã–π
              5: '#0000FF',  // —Å–∏–Ω–∏–π
              4: '#00FF00',  // –∑–µ–ª–µ–Ω—ã–π (–¥—Ä—É–≥–æ–π –∏–Ω–¥–µ–∫—Å)
            };
            const color = colorMap[cell.s.fill.fgColor.indexed];
            if (color) return color;
          }
          // –¶–≤–µ—Ç –ø–æ —Ç–µ–º–µ
          if (cell.s.fill.fgColor.theme !== undefined) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–≤–µ—Ç–æ–≤
            const themeColors: Record<number, string> = {
              2: '#00FF00', // –∑–µ–ª–µ–Ω—ã–π –≤ —Ç–µ–º–µ
              5: '#00B050', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
            };
            return themeColors[cell.s.fill.fgColor.theme] || null;
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º bgColor
        if (cell.s.fill.bgColor) {
          if (cell.s.fill.bgColor.rgb) {
            const rgb = cell.s.fill.bgColor.rgb;
            return rgb.startsWith('#') ? rgb : `#${rgb}`;
          }
          if (cell.s.fill.bgColor.indexed !== undefined) {
            const colorMap: Record<number, string> = {
              10: '#00FF00',
              43: '#92D050',
              50: '#00B050',
              35: '#00B050',
              42: '#00AC4A',
              51: '#C6E0B4',
            };
            return colorMap[cell.s.fill.bgColor.indexed] || null;
          }
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      if (cell.s.fgColor || cell.s.bgColor) {
        const fgColor = cell.s.fgColor;
        const bgColor = cell.s.bgColor;
        
        if (fgColor) {
          if (fgColor.rgb) {
            const rgb = fgColor.rgb;
            return rgb.startsWith('#') ? rgb : `#${rgb}`;
          }
          if (fgColor.indexed !== undefined) {
            const colorMap: Record<number, string> = {
              10: '#00FF00', 43: '#92D050', 50: '#00B050',
              35: '#00B050', 42: '#00AC4A', 51: '#C6E0B4',
              3: '#FF0000', 5: '#0000FF', 4: '#00FF00'
            };
            return colorMap[fgColor.indexed] || null;
          }
        }
        
        if (bgColor) {
          if (bgColor.rgb) {
            const rgb = bgColor.rgb;
            return rgb.startsWith('#') ? rgb : `#${rgb}`;
          }
          if (bgColor.indexed !== undefined) {
            const colorMap: Record<number, string> = {
              10: '#00FF00', 43: '#92D050', 50: '#00B050',
              35: '#00B050', 42: '#00AC4A', 51: '#C6E0B4'
            };
            return colorMap[bgColor.indexed] || null;
          }
        }
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (cell.h && typeof cell.h === 'string') {
      // –ò—â–µ–º —Ü–≤–µ—Ç –≤ HTML —Å—Ç–∏–ª—è—Ö
      const bgColorMatch = cell.h.match(/background-color:\s*([^;]+)/i);
      if (bgColorMatch) {
        const color = bgColorMatch[1].trim();
        if (color.startsWith('#')) return color;
        if (color.startsWith('rgb')) {
          // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞–µ–º rgb –≤ hex
          const rgbMatch = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
          if (rgbMatch) {
            const [, r, g, b] = rgbMatch;
            return `#${parseInt(r).toString(16).padStart(2, '0')}${parseInt(g).toString(16).padStart(2, '0')}${parseInt(b).toString(16).padStart(2, '0')}`;
          }
        }
      }
    }
    
    return null;
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–≤–µ—Ç –∑–µ–ª–µ–Ω—ã–º
  const isGreenColor = (color: string): boolean => {
    if (!color) return false;
    const normalizedColor = color.toUpperCase();
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –∑–µ–ª–µ–Ω—ã–µ —Ü–≤–µ—Ç–∞
    const greenColors = [
      '#00FF00', '#00ff00', // —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π
      '#92D050', '#92d050', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
      '#00B050', '#00b050', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
      '#00AC4A', '#00ac4a', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
      '#C6E0B4', '#c6e0b4', // –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
      '#008000', '#90EE90', // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–µ–ª–µ–Ω—ã–µ
      '#98FB98', '#00FA9A', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–µ
      '#32CD32', '#7CFC00', // —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–µ
      '#ADFF2F', '#9AFF9A', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–µ
      '#228B22', '#006400', // —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–µ
      '#8FBC8F', '#F0FFF0', // –±–ª–µ–¥–Ω–æ-–∑–µ–ª–µ–Ω—ã–µ
      '#E6FFE6', '#F5FFF5'  // –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–µ –∑–µ–ª–µ–Ω—ã–µ
    ];
    
    if (greenColors.includes(normalizedColor)) {
      return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º RGB –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –ª—é–±—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤ –∑–µ–ª–µ–Ω–æ–≥–æ)
    if (normalizedColor.startsWith('#') && normalizedColor.length === 7) {
      const r = parseInt(normalizedColor.substr(1, 2), 16);
      const g = parseInt(normalizedColor.substr(3, 2), 16);
      const b = parseInt(normalizedColor.substr(5, 2), 16);
      
      // –¶–≤–µ—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–µ–ª–µ–Ω—ã–º, –µ—Å–ª–∏:
      // 1. –ó–µ–ª–µ–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –±–æ–ª—å—à–µ –∫—Ä–∞—Å–Ω–æ–π –∏ —Å–∏–Ω–µ–π
      // 2. –ó–µ–ª–µ–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –±–æ–ª—å—à–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞
      return g > r && g > b && g > 100;
    }
    
    return false;
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫ –ø–æ —Ü–≤–µ—Ç—É
  const filterRowsByColor = (rows: any[][], colors: Map<string, string>, filter: 'all' | 'exclude_green' | 'only_green'): any[][] => {
    console.log(`Filtering ${rows.length} rows with filter: ${filter}`);
    console.log('Colors map:', colors);
    
    const filteredRows = rows.filter((_, rowIndex) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–µ–ª–µ–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ
      const cellsInRow = Array.from(colors.entries()).filter(([key]) => {
        const [r] = key.split('-').map(Number);
        return r === rowIndex;
      });
      
      const greenCellsInRow = cellsInRow.filter(([, color]) => isGreenColor(color));
      const hasGreenColor = greenCellsInRow.length > 0;
      
      if (hasGreenColor) {
        console.log(`Row ${rowIndex} has green cells:`, greenCellsInRow);
      }
      
      switch (filter) {
        case 'exclude_green':
          return !hasGreenColor;
        case 'only_green':
          return hasGreenColor;
        case 'all':
        default:
          return true;
      }
    });
    
    console.log(`After filtering: ${filteredRows.length} rows`);
    return filteredRows;
  };
  const findHeaderRow = (data: any[][]) => {
    // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–Ω–æ–≥–∏—Ö —è—á–µ–π–∫–∞—Ö
    for (let rowIndex = 0; rowIndex < Math.min(data.length, 10); rowIndex++) {
      const row = data[rowIndex];
      if (!Array.isArray(row)) continue;
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—É—Å—Ç—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —è—á–µ–µ–∫
      const textCells = row.filter(cell => {
        if (!cell) return false;
        const cellStr = String(cell).trim();
        return cellStr.length > 0 && isNaN(Number(cell));
      });
      
      // –ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –±–æ–ª—å—à–µ 3 —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —è—á–µ–µ–∫, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
      if (textCells.length >= 3) {
        console.log(`Found potential header row at index ${rowIndex}:`, row);
        return rowIndex;
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
    return 0;
  };
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–≤—Ä–∏—Ç–∞
  const autoMapColumns = (headers: string[]) => {
    const mappings = {
      drawingNumber: '',
      deadline: '',
      quantity: '',
      priority: ''
    };

    // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (—Ä—É—Å—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∏–≤—Ä–∏—Ç)
    headers.forEach(header => {
      const lowerHeader = header.toLowerCase();
      
      // –ù–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞ / –∞—Ä—Ç–∏–∫—É–ª / –º–∫—Ç
      if (!mappings.drawingNumber && (
        lowerHeader.includes('–Ω–æ–º–µ—Ä') || 
        lowerHeader.includes('—á–µ—Ä—Ç–µ–∂') || 
        lowerHeader.includes('drawing') || 
        lowerHeader.includes('number') || 
        lowerHeader.includes('‚Ññ') ||
        lowerHeader.includes('–∞—Ä—Ç–∏–∫—É–ª') ||
        lowerHeader.includes('–¥–µ—Ç–∞–ª—å') ||
        lowerHeader.includes('◊û◊ß◊ò') || // –º–∫—Ç (–∞—Ä—Ç–∏–∫—É–ª –Ω–∞ –∏–≤—Ä–∏—Ç–µ)
        lowerHeader.includes('part') ||
        lowerHeader.includes('item')
      )) {
        mappings.drawingNumber = header;
      }
      
      // –î–µ–¥–ª–∞–π–Ω / —Å—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–∫–∏
      if (!mappings.deadline && (
        lowerHeader.includes('–¥–µ–¥–ª–∞–π–Ω') || 
        lowerHeader.includes('—Å—Ä–æ–∫') || 
        lowerHeader.includes('deadline') || 
        lowerHeader.includes('–¥–∞—Ç–∞') || 
        lowerHeader.includes('date') ||
        lowerHeader.includes('–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å') ||
        lowerHeader.includes('–ø–æ—Å—Ç–∞–≤–∫–∞') ||
        lowerHeader.includes('–∞—Å–ø–∫–∞') || // –∞—Å–ø–∫–∞ (–ø–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –∏–≤—Ä–∏—Ç–µ)
        lowerHeader.includes('◊ê◊°◊§◊ß◊î') || // –∞—Å–ø–∞–∫–∞ (–ø–æ—Å—Ç–∞–≤–∫–∞)
        lowerHeader.includes('delivery') ||
        lowerHeader.includes('due')
      )) {
        mappings.deadline = header;
      }
      
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
      if (!mappings.quantity && (
        lowerHeader.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || 
        lowerHeader.includes('–∫–æ–ª-–≤–æ') || 
        lowerHeader.includes('–∫–æ–ª') || 
        lowerHeader.includes('quantity') || 
        lowerHeader.includes('—à—Ç') ||
        lowerHeader.includes('qty') ||
        lowerHeader.includes('count') ||
        lowerHeader.includes('◊õ◊û◊ï◊™') || // –∫–º—É—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –∏–≤—Ä–∏—Ç–µ)
        lowerHeader.includes('amount')
      )) {
        mappings.quantity = header;
      }
      
      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç / —Å—Ç–∞—Ç—É—Å
      if (!mappings.priority && (
        lowerHeader.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || 
        lowerHeader.includes('priority') || 
        lowerHeader.includes('–≤–∞–∂–Ω–æ—Å—Ç—å') || 
        lowerHeader.includes('—Å—Ä–æ—á–Ω–æ—Å—Ç—å') ||
        lowerHeader.includes('status') ||
        lowerHeader.includes('—Å—Ç–∞—Ç—É—Å') ||
        lowerHeader.includes('◊°◊ò◊ò◊ï◊°') || // —Å—Ç–∞—Ç—É—Å –Ω–∞ –∏–≤—Ä–∏—Ç–µ
        lowerHeader.includes('◊ì◊ó◊ô◊§◊ï◊ô◊ï◊™') // –¥—Ö–∏—Ñ—É–π–æ—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –Ω–∞ –∏–≤—Ä–∏—Ç–µ)
      )) {
        mappings.priority = header;
      }
    });

    return mappings;
  };

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
  useEffect(() => {
    if (originalExcelData.length > 0 && cellColors.size > 0) {
      const filteredRows = filterRowsByColor(originalExcelData, cellColors, colorFilter);
      setExcelData(filteredRows);
    }
  }, [colorFilter, originalExcelData, cellColors]);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
  const applyColorFilter = () => {
    if (originalExcelData.length > 0) {
      const filteredRows = filterRowsByColor(originalExcelData, cellColors, colorFilter);
      setExcelData(filteredRows);
    }
  };
  
  const filteredOrders = orders.filter(order => 
    order.drawingNumber.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const fileData = evt.target?.result;
        let workbook;
        
        // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç–∏–ª–µ–π
        if (fileData instanceof ArrayBuffer) {
          workbook = XLSX.read(fileData, { 
            type: 'array',
            cellStyles: true,
            cellHTML: true,
            cellNF: true,
            cellDates: true
          });
        } else {
          workbook = XLSX.read(fileData, { 
            type: 'binary',
            cellStyles: true,
            cellHTML: true,
            cellNF: true,
            cellDates: true
          });
        }
        
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        
        console.log('Worksheet object:', worksheet);
        console.log('Sample cell with style:', worksheet['A1']);
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤
        const excelSheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' }) as any[][];
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ —è—á–µ–µ–∫ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ
        const colors = new Map<string, string>();
        const uniqueColors = new Set<string>();
        const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
        
        console.log('Analyzing colors in range:', range);
        
        for (let row = range.s.r; row <= range.e.r; row++) {
          for (let col = range.s.c; col <= range.e.c; col++) {
          const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
          const cell = worksheet[cellAddress];
          
          if (cell) {
          console.log(`Cell ${cellAddress}:`, {
          value: cell.v,
          style: cell.s,
          html: cell.h
          });
          
          const color = getCellColor(worksheet, row, col);
          if (color) {
          colors.set(`${row}-${col}`, color);
          uniqueColors.add(color);
          console.log(`Found color ${color} at ${cellAddress}`);
          }
          }
          }
        }
        
        console.log('Detected colors:', Array.from(uniqueColors));
        console.log('Cell colors map:', colors);
        
        console.log('Raw Excel data:', excelSheetData); // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        
        if (excelSheetData.length > 0) {
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
          const foundHeaderRowIndex = findHeaderRow(excelSheetData);
          console.log(`Using header row at index: ${foundHeaderRowIndex}`);
          
          // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
          const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
          const headers: string[] = [];
          
          // –ß–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
          for (let col = range.s.c; col <= range.e.c; col++) {
            const cellAddress = XLSX.utils.encode_cell({ r: foundHeaderRowIndex, c: col });
            const cell = worksheet[cellAddress];
            
            if (cell) {
              let headerValue = '';
              if (cell.w) {
                headerValue = String(cell.w).trim();
              } else if (cell.v !== undefined && cell.v !== null) {
                headerValue = String(cell.v).trim();
              } else if (cell.h) {
                headerValue = String(cell.h).trim();
              }
              
              headers.push(headerValue || `–ö–æ–ª–æ–Ω–∫–∞ ${col + 1}`);
            } else {
              headers.push(`–ö–æ–ª–æ–Ω–∫–∞ ${col + 1}`);
            }
          }
          
          console.log('Extracted headers:', headers);
          
          // –¢–∞–∫–∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø–æ–ª—É—á–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö
          if (excelSheetData[foundHeaderRowIndex]) {
            const rowHeaders = excelSheetData[foundHeaderRowIndex] as any[];
            rowHeaders.forEach((header, index) => {
              if (header && String(header).trim() && (!headers[index] || headers[index].startsWith('–ö–æ–ª–æ–Ω–∫–∞'))) {
                headers[index] = String(header).trim();
              }
            });
          }
          
          // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –∫–æ–Ω—Ü–µ
          while (headers.length > 0 && 
                 (headers[headers.length - 1] === '' || headers[headers.length - 1].startsWith('–ö–æ–ª–æ–Ω–∫–∞'))) {
            const hasDataInColumn = excelSheetData.slice(foundHeaderRowIndex + 1).some(row => 
              Array.isArray(row) && row[headers.length - 1] !== null && 
              row[headers.length - 1] !== undefined && 
              String(row[headers.length - 1]).trim() !== ''
            );
            if (hasDataInColumn) break;
            headers.pop();
          }
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏
          const autoMappings = autoMapColumns(headers);
          console.log('Auto mappings:', autoMappings);
          setColumnMappings(autoMappings);
          
          // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–∏—Å–∫–ª—é—á–∞—è –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Å–∞–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
          let rows = excelSheetData.slice(foundHeaderRowIndex + 1).filter(row => 
            Array.isArray(row) && row.some(cell => 
              cell !== null && cell !== undefined && String(cell).trim() !== ''
            )
          );
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä
          const adjustedColors = new Map<string, string>();
          colors.forEach((color, key) => {
            const [r] = key.split('-').map(Number);
            if (r > foundHeaderRowIndex) {
              adjustedColors.set(`${r - foundHeaderRowIndex - 1}-${key.split('-')[1]}`, color);
            }
          });
          
          const filteredRows = filterRowsByColor(rows as any[][], adjustedColors, colorFilter);
          console.log(`Original rows: ${rows.length}, Filtered rows: ${filteredRows.length}`);
          
          setCellColors(adjustedColors);
          setDetectedColors(Array.from(uniqueColors));
          setOriginalExcelData(rows); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          
          console.log('Filtered rows:', rows);
          console.log(`Skipped ${foundHeaderRowIndex} rows before headers`);
          
          if (headers.length === 0) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Ñ–∞–π–ª–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–æ–ª–æ–Ω–æ–∫.');
            return;
          }
          
          setExcelHeaders(headers);
          setExcelData(filteredRows);
          setShowImportModal(true);
        } else {
          alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö.');
        }
      } catch (error) {
        console.error('Error parsing Excel file:', error);
        alert(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel —Ñ–∞–π–ª–∞: ${error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
      }
    };
    // –ü—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å –∫–∞–∫ ArrayBuffer –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if (reader.readAsArrayBuffer) {
      reader.readAsArrayBuffer(file);
    } else {
      reader.readAsBinaryString(file);
    }
  };

  const handleImport = () => {
    try {
      if (!Array.isArray(excelData) || excelData.length === 0) {
        alert(t('no_data_to_import'));
        return;
      }

      const importedOrders: any[] = [];
      const duplicates: any[] = [];
      const errors: any[] = [];

      excelData.forEach((row, index) => {
        // Check that row is an array
        if (!Array.isArray(row)) {
          console.warn(`–°—Ç—Ä–æ–∫–∞ ${index} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:`, row);
          errors.push(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ`);
          return;
        }

        const drawingNumberIndex = excelHeaders.indexOf(columnMappings.drawingNumber);
        const deadlineIndex = excelHeaders.indexOf(columnMappings.deadline);
        const quantityIndex = excelHeaders.indexOf(columnMappings.quantity);
        const priorityIndex = excelHeaders.indexOf(columnMappings.priority);

        const drawingNumber = drawingNumberIndex >= 0 ? String(row[drawingNumberIndex] || '').trim() : '';
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ —á–µ—Ä—Ç–µ–∂–∞
        if (!drawingNumber) {
          errors.push(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞`);
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–∞—Ö
        if (orders.some(order => order.drawingNumber === drawingNumber)) {
          duplicates.push({
            row: index + 1,
            drawingNumber,
            reason: '–ó–∞–∫–∞–∑ —Å —ç—Ç–∏–º –Ω–æ–º–µ—Ä–æ–º —á–µ—Ä—Ç–µ–∂–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
          });
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –≤ —Ç–µ–∫—É—â–µ–π –ø–æ—Ä—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞
        if (importedOrders.some(order => order.drawingNumber === drawingNumber)) {
          duplicates.push({
            row: index + 1,
            drawingNumber,
            reason: '–î—É–±–ª–∏–∫–∞—Ç –≤ —Ñ–∞–π–ª–µ –∏–º–ø–æ—Ä—Ç–∞'
          });
          return;
        }

        const order = {
          id: `imported-${Date.now()}-${index}`,
          drawingNumber,
          deadline: deadlineIndex >= 0 ? (() => {
            const dateValue = row[deadlineIndex];
            if (!dateValue) return new Date().toISOString();
            
            // If this is an Excel serial date number
            if (typeof dateValue === 'number') {
              const excelEpoch = new Date(1900, 0, -1);
              const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
              return isNaN(date.getTime()) ? new Date().toISOString() : date.toISOString();
            }
            
            // Attempt to parse as a string
            const parsedDate = new Date(dateValue);
            return isNaN(parsedDate.getTime()) ? new Date().toISOString() : parsedDate.toISOString();
          })() : new Date().toISOString(),
          quantity: quantityIndex >= 0 ? (isNaN(Number(row[quantityIndex])) ? 0 : Number(row[quantityIndex])) : 0,
          priority: priorityIndex >= 0 ? (isNaN(Number(row[priorityIndex])) ? 0 : Number(row[priorityIndex])) : 0,
          operations: []
        };
        
        importedOrders.push(order);
      });

      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–º–ø–æ—Ä—Ç–∞
      let message = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–ø–æ—Ä—Ç–∞:\n\n`;
      message += `‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${importedOrders.length} –∑–∞–∫–∞–∑–æ–≤\n`;
      
      if (duplicates.length > 0) {
        message += `‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicates.length}\n`;
        if (duplicates.length <= 5) {
          duplicates.forEach(dup => {
            message += `  ‚Ä¢ –°—Ç—Ä–æ–∫–∞ ${dup.row}: ${dup.drawingNumber} (${dup.reason})\n`;
          });
        } else {
          message += `  ‚Ä¢ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞\n`;
          console.log('–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã:', duplicates);
        }
      }
      
      if (errors.length > 0) {
        message += `‚ùå –û—à–∏–±–∫–∏: ${errors.length}\n`;
        if (errors.length <= 3) {
          errors.forEach(error => {
            message += `  ‚Ä¢ ${error}\n`;
          });
        } else {
          message += `  ‚Ä¢ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞\n`;
          console.log('–û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞:', errors);
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–∫–∞–∑—ã –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      let successfulAdditions = 0;
      importedOrders.forEach(order => {
        if (addOrder(order)) {
          successfulAdditions++;
        }
      });

      // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setShowImportModal(false);
      setColumnMappings({
        drawingNumber: '',
        deadline: '',
        quantity: '',
        priority: ''
      });
      setExcelData([]);
      setExcelHeaders([]);
      setOriginalExcelData([]);
      setCellColors(new Map());
      setDetectedColors([]);

      alert(message);
    } catch (error) {
      console.error('Error importing data:', error);
      alert(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
  };

  const handleEditOrder = (order: Order) => {
    setEditingOrder(order);
  };

  const handleTrashContextMenu = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setContextMenu({ x: e.clientX, y: e.clientY });
  };

  const handleTrashClick = (orderId: string) => {
    deleteOrder(orderId);
  };

  const handleDeleteAll = () => {
    if (filteredOrders.length === 0) {
      alert(t('no_orders_to_delete'));
      setContextMenu(null);
      return;
    }
    
    const countToDelete = filteredOrders.length;
    
    if (window.confirm(t('confirm_delete_all', { count: countToDelete }))) {
      filteredOrders.forEach(order => deleteOrder(order.id));
      setContextMenu(null);
      alert(t('deleted_orders', { count: countToDelete }));
    }
  };

  const handleSelectiveDelete = () => {
    if (filteredOrders.length === 0) {
      alert(t('no_orders_to_select'));
      setContextMenu(null);
      return;
    }
    setShowBulkDeleteModal(true);
    setContextMenu(null);
  };

  const handleBulkDelete = () => {
    if (selectedOrderIds.size === 0) return;
    
    const countToDelete = selectedOrderIds.size;
    
    if (window.confirm(t('confirm_delete_selected', { count: countToDelete }))) {
      selectedOrderIds.forEach(orderId => deleteOrder(orderId));
      setSelectedOrderIds(new Set());
      setShowBulkDeleteModal(false);
      alert(t('deleted_orders', { count: countToDelete }));
    }
  };

  const toggleOrderSelection = (orderId: string) => {
    const newSelected = new Set(selectedOrderIds);
    if (newSelected.has(orderId)) {
      newSelected.delete(orderId);
    } else {
      newSelected.add(orderId);
    }
    setSelectedOrderIds(newSelected);
  };

  const selectAllOrders = () => {
    if (selectedOrderIds.size === filteredOrders.length) {
      setSelectedOrderIds(new Set());
    } else {
      setSelectedOrderIds(new Set(filteredOrders.map(order => order.id)));
    }
  };



  useEffect(() => {
    if (contextMenu) {
      const handleClick = () => setContextMenu(null);
      const handleContextMenu = () => setContextMenu(null);
      
      document.addEventListener('click', handleClick);
      document.addEventListener('contextmenu', handleContextMenu);
      
      return () => {
        document.removeEventListener('click', handleClick);
        document.removeEventListener('contextmenu', handleContextMenu);
      };
    }
  }, [contextMenu]);

  return (
    <div className="container mx-auto">
      <h1 className="text-2xl font-bold mb-6" style={{ fontFamily: 'Montserrat, sans-serif' }}>{t('orders_list')}</h1>
      
      <div className="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div className="relative w-full md:w-64">
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <Search className="h-5 w-5 text-gray-400" />
          </div>
          <input
            type="text"
            placeholder={t('search_by_drawing')}
            className="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
        
        <label className="flex items-center justify-center md:w-auto px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer">
          <Upload className="mr-2 h-5 w-5 text-gray-400" />
          <span>{t('import_excel')}</span>
          <input type="file" className="sr-only" onChange={handleFileUpload} accept=".xlsx, .xls" />
        </label>
      </div>
      
      <div className="mt-6">
        <OrderForm />
      </div>
      
      <div className="mt-8 mb-8">
        <SupabaseSync />
      </div>
      
      {filteredOrders.length > 0 && (
        <div className="mt-8">
          <h2 className="text-xl font-semibold mb-4">{t('existing_orders')}</h2>
          <div className="bg-white rounded-lg shadow overflow-hidden">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('drawing_number')}
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('deadline')}
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('quantity')}
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('priority')}
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('operations')}
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    {t('actions')}
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {filteredOrders.map((order) => (
                  <tr key={order.id}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {order.drawingNumber}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(order.deadline).toLocaleDateString()}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {order.quantity}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {order.priority}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {order.operations.length}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <div className="flex space-x-2">
                        <button
                          onClick={() => handleEditOrder(order)}
                          className="text-blue-600 hover:text-blue-800 p-1"
                          title={t('edit_caps')}
                        >
                          <Edit size={16} />
                        </button>
                        <button
                          onClick={() => handleTrashClick(order.id)}
                          onContextMenu={(e) => handleTrashContextMenu(e)}
                          className="text-red-600 hover:text-red-800 p-1"
                          title={t('left_click_delete_right_click_bulk')}
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Context Menu */}
      {contextMenu && filteredOrders.length > 0 && (
        <div 
          className="fixed bg-white shadow-lg border rounded-md py-1 z-50 min-w-48"
          style={{ left: contextMenu.x, top: contextMenu.y }}
        >
          <button
            onClick={handleDeleteAll}
            className="flex items-center w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition-colors"
          >
            <Trash2 className="mr-2" size={16} />
            {t('delete_all_orders')} ({filteredOrders.length})
          </button>
          <hr className="my-1" />
          <button
            onClick={handleSelectiveDelete}
            className="flex items-center w-full text-left px-4 py-2 hover:bg-blue-50 text-blue-600 transition-colors"
          >
            <Edit className="mr-2" size={16} />
            {t('selective_delete')}
          </button>
        </div>
      )}

      {/* Bulk Delete Modal */}
      {showBulkDeleteModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-96 overflow-hidden flex flex-col">
            <h2 className="text-xl font-bold mb-4">{t('selective_delete_orders')}</h2>
            
            {/* Statistics and "Select all" button */}
            <div className="mb-4 flex justify-between items-center">
              <button
                onClick={selectAllOrders}
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                {selectedOrderIds.size === filteredOrders.length ? t('cancel_select_all') : t('select_all')}
              </button>
              <span className="text-sm text-gray-600">
                {t('selected')}: <span className="font-semibold">{selectedOrderIds.size}</span> {t('of')} <span className="font-semibold">{filteredOrders.length}</span>
              </span>
            </div>
            
            {/* Scrollable order list */}
            <div className="flex-1 overflow-y-auto border border-gray-200 rounded-md">
              <div className="p-4 space-y-3">
                {filteredOrders.length === 0 ? (
                  <div className="text-gray-500 text-center py-4">
                    {t('no_orders_to_display')}
                  </div>
                ) : (
                  filteredOrders.map((order) => (
                    <label key={order.id} className={`flex items-center space-x-3 p-3 rounded-lg border transition-colors cursor-pointer ${
                      selectedOrderIds.has(order.id) 
                        ? 'bg-blue-50 border-blue-200' 
                        : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                    }`}>
                      <input
                        type="checkbox"
                        checked={selectedOrderIds.has(order.id)}
                        onChange={() => toggleOrderSelection(order.id)}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      />
                      <div className="flex-1">
                        <div className="font-medium text-gray-900">{order.drawingNumber}</div>
                        <div className="text-sm text-gray-500">
                          {t('count_label')} {order.quantity} | {t('priority_label')} {order.priority} | 
                          {t('deadline_label')} {new Date(order.deadline).toLocaleDateString()} | 
                          {t('operations_label')} {order.operations.length}
                        </div>
                      </div>
                    </label>
                  ))
                )}
              </div>
            </div>
            
            {/* Action buttons */}
            <div className="mt-6 flex justify-end space-x-3">
              <button
                onClick={() => {
                  setShowBulkDeleteModal(false);
                  setSelectedOrderIds(new Set());
                }}
                className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
              >
                {t('cancel_caps')}
              </button>
              <button
                onClick={handleBulkDelete}
                disabled={selectedOrderIds.size === 0}
                className={`px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white transition-colors ${
                  selectedOrderIds.size === 0 
                    ? 'bg-gray-400 cursor-not-allowed' 
                    : 'bg-red-600 hover:bg-red-700'
                }`}
              >
                {t('delete_selected')} ({selectedOrderIds.size})
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Edit Order Modal */}
      {editingOrder && (
        <EditOrderModal 
          isOpen={!!editingOrder}
          onClose={() => setEditingOrder(null)}
          order={editingOrder}
        />
      )}
      
      {/* Import Modal */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 className="text-xl font-bold mb-4">{t('assign_columns_for_import')}</h2>
            
            {/* –¶–≤–µ—Ç–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä */}
            {detectedColors.length > 0 && (
              <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 className="text-sm font-semibold text-blue-800 mb-3">üé® –§–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É —è—á–µ–µ–∫</h3>
                <div className="space-y-2">
                  <div className="text-xs text-blue-700 mb-2">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ü–≤–µ—Ç–∞:</div>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {detectedColors.map((color, index) => (
                      <div key={index} className="flex items-center space-x-1 text-xs">
                        <div 
                          className="w-4 h-4 border border-gray-300 rounded"
                          style={{ backgroundColor: color }}
                        ></div>
                        <span className="text-gray-600">{color}</span>
                        {isGreenColor(color) && <span className="text-green-600">(üü¢)</span>}
                      </div>
                    ))}
                  </div>
                  <div className="space-y-2">
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="colorFilter"
                        value="all"
                        checked={colorFilter === 'all'}
                        onChange={(e) => setColorFilter(e.target.value as any)}
                        className="text-blue-600"
                      />
                      <span className="text-sm">üìã –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="colorFilter"
                        value="exclude_green"
                        checked={colorFilter === 'exclude_green'}
                        onChange={(e) => setColorFilter(e.target.value as any)}
                        className="text-blue-600"
                      />
                      <span className="text-sm">‚ùå –ò—Å–∫–ª—é—á–∏—Ç—å –∑–µ–ª–µ–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="colorFilter"
                        value="only_green"
                        checked={colorFilter === 'only_green'}
                        onChange={(e) => setColorFilter(e.target.value as any)}
                        className="text-blue-600"
                      />
                      <span className="text-sm">‚úÖ –¢–æ–ª—å–∫–æ –∑–µ–ª–µ–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</span>
                    </label>
                  </div>
                  <div className="flex justify-between items-center mt-3">
                    <div className="text-xs text-gray-600">
                      –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞: <span className="font-semibold">{excelData.length}</span>
                    </div>
                    <button
                      onClick={applyColorFilter}
                      className="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                      –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                    </button>
                  </div>
                </div>
              </div>
            )}
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('drawing_number_label')}</label>
                <select
                  className={`w-full border rounded-md px-3 py-2 ${
                    columnMappings.drawingNumber 
                      ? 'border-green-500 bg-green-50' 
                      : 'border-gray-300'
                  }`}
                  value={columnMappings.drawingNumber}
                  onChange={(e) => setColumnMappings({...columnMappings, drawingNumber: e.target.value})}
                >
                  <option value="">{columnMappings.drawingNumber ? `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${columnMappings.drawingNumber}` : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É'}</option>
                  {excelHeaders.map((header, index) => (
                    <option key={index} value={header}>
                      {header || `[–ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ ${index + 1}]`}
                    </option>
                  ))}
                </select>
                {columnMappings.drawingNumber && (
                  <div className="text-xs text-green-600 mt-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ: {columnMappings.drawingNumber}</div>
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('deadline_date_label')}</label>
                <select
                  className={`w-full border rounded-md px-3 py-2 ${
                    columnMappings.deadline 
                      ? 'border-green-500 bg-green-50' 
                      : 'border-gray-300'
                  }`}
                  value={columnMappings.deadline}
                  onChange={(e) => setColumnMappings({...columnMappings, deadline: e.target.value})}
                >
                  <option value="">{columnMappings.deadline ? `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${columnMappings.deadline}` : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É'}</option>
                  {excelHeaders.map((header, index) => (
                    <option key={index} value={header}>
                      {header || `[–ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ ${index + 1}]`}
                    </option>
                  ))}
                </select>
                {columnMappings.deadline && (
                  <div className="text-xs text-green-600 mt-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ: {columnMappings.deadline}</div>
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('quantity_label')}</label>
                <select
                  className={`w-full border rounded-md px-3 py-2 ${
                    columnMappings.quantity 
                      ? 'border-green-500 bg-green-50' 
                      : 'border-gray-300'
                  }`}
                  value={columnMappings.quantity}
                  onChange={(e) => setColumnMappings({...columnMappings, quantity: e.target.value})}
                >
                  <option value="">{columnMappings.quantity ? `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${columnMappings.quantity}` : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É'}</option>
                  {excelHeaders.map((header, index) => (
                    <option key={index} value={header}>
                      {header || `[–ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ ${index + 1}]`}
                    </option>
                  ))}
                </select>
                {columnMappings.quantity && (
                  <div className="text-xs text-green-600 mt-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ: {columnMappings.quantity}</div>
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('priority_label_full')}</label>
                <select
                  className={`w-full border rounded-md px-3 py-2 ${
                    columnMappings.priority 
                      ? 'border-green-500 bg-green-50' 
                      : 'border-gray-300'
                  }`}
                  value={columnMappings.priority}
                  onChange={(e) => setColumnMappings({...columnMappings, priority: e.target.value})}
                >
                  <option value="">{columnMappings.priority ? `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${columnMappings.priority}` : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É'}</option>
                  {excelHeaders.map((header, index) => (
                    <option key={index} value={header}>
                      {header || `[–ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ ${index + 1}]`}
                    </option>
                  ))}
                </select>
                {columnMappings.priority && (
                  <div className="text-xs text-green-600 mt-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ: {columnMappings.priority}</div>
                )}
              </div>
            </div>
            <div className="mt-6 flex justify-end space-x-3">
              <button
                className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                onClick={() => {
                  setShowImportModal(false);
                  setExcelData([]);
                  setExcelHeaders([]);
                  setOriginalExcelData([]);
                  setCellColors(new Map());
                  setDetectedColors([]);
                  setColumnMappings({
                    drawingNumber: '',
                    deadline: '',
                    quantity: '',
                    priority: ''
                  });
                }}
              >
                {t('cancel_caps')}
              </button>
              <button
                className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                onClick={handleImport}
              >
                {t('import_caps')}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}