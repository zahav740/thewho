@echo off
echo ====================================
echo –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –ó–ê–ü–£–°–ö BACKEND
echo ====================================

echo [1/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js...
tasklist /fi "imagename eq node.exe" 2>nul | find "node.exe"
if %errorlevel% == 0 (
    echo ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js
    echo –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö...
    taskkill /f /im node.exe 2>nul
    timeout /t 3 /nobreak >nul
) else (
    echo ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
)

echo.
echo [2/5] –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend...
cd /d "%~dp0\backend"
if not exist package.json (
    echo ‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!
    echo –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
    pause
    exit /b 1
)
echo ‚úÖ –ù–∞—Ö–æ–¥–∏–º—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend

echo.
echo [3/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 5100...
netstat -an | find ":5100 " >nul 2>&1
if %errorlevel% == 0 (
    echo ‚ö†Ô∏è –ü–æ—Ä—Ç 5100 –∑–∞–Ω—è—Ç, –ø—ã—Ç–∞–µ–º—Å—è –æ—Å–≤–æ–±–æ–¥–∏—Ç—å...
    for /f "tokens=5" %%i in ('netstat -ano ^| find ":5100 "') do (
        echo –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å %%i...
        taskkill /f /pid %%i 2>nul
    )
    timeout /t 2 /nobreak >nul
) else (
    echo ‚úÖ –ü–æ—Ä—Ç 5100 —Å–≤–æ–±–æ–¥–µ–Ω
)

echo.
echo [4/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
if not exist node_modules (
    echo ‚ö†Ô∏è –ü–∞–ø–∫–∞ node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
    call npm install
    if %errorlevel% neq 0 (
        echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        pause
        exit /b 1
    )
) else (
    echo ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
)

echo.
echo [5/5] –ó–∞–ø—É—Å–∫–∞–µ–º backend —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ buffer...
echo.
echo üîß –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
echo   ‚úÖ –£–±—Ä–∞–Ω diskStorage –∏–∑ FileInterceptor  
echo   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ file.buffer
echo   ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Excel —Ñ–∞–π–ª–æ–≤
echo   ‚úÖ –£–±—Ä–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ frontend
echo.
echo üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5100...
echo.

rem –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
start "CRM Backend (Fixed Buffer)" cmd /k "echo BACKEND STARTING... && npm run start:dev"

echo.
echo ====================================
echo BACKEND –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø...
echo ====================================
echo üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Å–æ–ª–∏
echo üåê –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ http://localhost:5100
echo üìÅ –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ Excel —Ñ–∞–π–ª—ã
echo ====================================

timeout /t 5 /nobreak >nul

echo.
echo –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...
timeout /t 10 /nobreak >nul

curl -s http://localhost:5100/api/health >nul 2>&1
if %errorlevel% == 0 (
    echo ‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!
) else (
    echo ‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...
)

echo.
echo ====================================
echo –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–µ—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Excel –∏–º–ø–æ—Ä—Ç
echo ====================================

pause
