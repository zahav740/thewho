@echo off
echo ====================================
echo –ó–ê–ü–£–°–ö BACKEND (–ü–û–†–¢ 5100) –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø–ú–ò EXCEL
echo ====================================

echo [1/4] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5100...
netstat -ano | findstr ":5100.*LISTENING" >nul
if %errorlevel% == 0 (
    echo ‚ö†Ô∏è –ü–æ—Ä—Ç 5100 –∑–∞–Ω—è—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º...
    for /f "tokens=5" %%i in ('netstat -ano ^| findstr ":5100.*LISTENING"') do (
        echo –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å %%i...
        taskkill /f /pid %%i 2>nul
    )
    timeout /t 2 /nobreak >nul
) else (
    echo ‚úÖ –ü–æ—Ä—Ç 5100 —Å–≤–æ–±–æ–¥–µ–Ω
)

echo.
echo [2/4] –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend...
cd /d "%~dp0\backend"
if not exist package.json (
    echo ‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!
    echo –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
    pause
    exit /b 1
)
echo ‚úÖ –ù–∞—Ö–æ–¥–∏–º—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend

echo.
echo [3/4] –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
if not exist node_modules (
    echo ‚ö†Ô∏è –ü–∞–ø–∫–∞ node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
    call npm install
    if %errorlevel% neq 0 (
        echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        pause
        exit /b 1
    )
) else (
    echo ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
)

echo.
echo [4/4] –ó–∞–ø—É—Å–∫–∞–µ–º backend –Ω–∞ –ø–æ—Ä—Ç—É 5100 —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ Excel...
echo.
echo üîß –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
echo   ‚úÖ –£–±—Ä–∞–Ω diskStorage –∏–∑ FileInterceptor  
echo   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ file.buffer
echo   ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Excel —Ñ–∞–π–ª–æ–≤
echo   ‚úÖ –ü–æ–∫–∞–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo   ‚úÖ –£–±—Ä–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
echo.
echo üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5100...
echo.

rem –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
start "üì° CRM Backend (Port 5100 - Excel Fixed)" cmd /k "title Backend 5100 Excel Fixed && echo BACKEND STARTING ON PORT 5100 WITH EXCEL BUFFER FIX... && npm run start:dev"

echo.
echo ====================================
echo BACKEND –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø –ù–ê –ü–û–†–¢–£ 5100...
echo ====================================
echo üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Å–æ–ª–∏
echo üåê –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ http://localhost:5100
echo üìã API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://localhost:5100/api
echo üìÅ –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ Excel —Ñ–∞–π–ª—ã
echo ====================================

timeout /t 5 /nobreak >nul

echo.
echo –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...
timeout /t 10 /nobreak >nul

curl -s http://localhost:5100/api/orders >nul 2>&1
if %errorlevel% == 0 (
    echo ‚úÖ Backend —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5100!
    echo üîó API: http://localhost:5100/api/orders
) else (
    echo ‚ö†Ô∏è Backend –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...
    echo üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–∫–Ω–æ –∫–æ–Ω—Å–æ–ª–∏ backend –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
)

echo.
echo ====================================
echo –ì–æ—Ç–æ–≤–æ! Backend –∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ Excel
echo –¢–µ–ø–µ—Ä—å –≤–∞—à–∏ Excel —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
echo ====================================

pause
