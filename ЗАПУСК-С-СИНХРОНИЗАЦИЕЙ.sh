#!/bin/bash

# üöÄ –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ –° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ï–ô PRODUCTION ‚Üî SHIFTS
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
# –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∏ –°–º–µ–Ω—ã

echo "üî• –ó–∞–ø—É—Å–∫ Production CRM —Å –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π..."
echo ""
echo "‚ú® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:"
echo "   üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Production ‚Üî Shifts"
echo "   üì° Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo "   üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo "   üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ–Ω –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "‚ùå PostgreSQL –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω."
    exit 1
fi

echo "1Ô∏è‚É£ –ó–∞–ø—É—Å–∫ Backend..."
cd backend

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
    npm install
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º backend –≤ —Ñ–æ–Ω–µ
echo "üöÄ –ó–∞–ø—É—Å–∫ Backend –Ω–∞ –ø–æ—Ä—Ç—É 5100..."
npm run start:dev &
BACKEND_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω
if curl -s "http://localhost:5100/api/health" > /dev/null; then
    echo "‚úÖ Backend –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ backend"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

echo ""
echo "2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ Frontend..."
cd ../frontend

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
    npm install
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ Frontend –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
npm start &
FRONTEND_PID=$!

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ frontend..."
sleep 15

echo ""
echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Å—ã–ª–∫–∏:"
echo "   Frontend: http://localhost:3000"
echo "   Backend API: http://localhost:5100/api"
echo "   API Docs: http://localhost:5100/api/docs"
echo ""
echo "üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ Production: http://localhost:3000/production"
echo "   2. –û—Ç–∫—Ä–æ–π—Ç–µ Shifts: http://localhost:3000/shifts"
echo "   3. –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é –≤ Production"
echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤ Shifts"
echo "   5. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—ä–µ–º –≤ Shifts"
echo "   6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Production"
echo ""
echo "üß™ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç:"
echo "   ./–¢–ï–°–¢-–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.sh"
echo ""
echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
echo "   –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø-–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.md"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    exit 0
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup SIGINT SIGTERM

echo "üîÑ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏."
echo ""

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
while true; do
    if ! kill -0 $BACKEND_PID 2>/dev/null; then
        echo "‚ùå Backend –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        cleanup
    fi
    
    if ! kill -0 $FRONTEND_PID 2>/dev/null; then
        echo "‚ùå Frontend –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        cleanup
    fi
    
    sleep 5
done
