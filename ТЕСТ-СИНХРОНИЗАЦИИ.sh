#!/bin/bash

# üî• –¢–ï–°–¢ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ü–†–û–ò–ó–í–û–î–°–¢–í–û ‚Üî –°–ú–ï–ù–´
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ Production –∏ Shifts
# 
# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
# 1. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: –í—ã–±–∏—Ä–∞—é—Ç –æ–ø–µ—Ä–∞—Ü–∏—é ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –≤ –ë–î
# 2. –°–º–µ–Ω–∞: –ü–æ–ª—É—á–∞–µ—Ç –≤–µ–±—Ö—É–∫ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –ø–ª–∞–Ω
# 3. –°–º–µ–Ω–∞: –î–µ–ª–∞–µ—Ç—Å—è –Ω–∞–ª–∞–¥–∫–∞ ‚Üí –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î
# 4. –°–º–µ–Ω–∞: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—ä–µ–º (–¥–µ–Ω—å/–Ω–æ—á—å) ‚Üí –∑–∞–ø–∏—Å–∞–ª–∏ –≤ –ë–î –∏ –æ—Ç–æ–±—Ä–∞–∑–∏–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å—Ç–∞–Ω–∫–∞
# 5. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç–∞–Ω–∫–∞
#

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
echo ""

# –ë–∞–∑–æ–≤—ã–π URL API
API_URL="http://localhost:5100/api"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
echo "üè• 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
curl -s -X GET "$API_URL/sync/health" | jq '.'
echo ""

# 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤
echo "üìã 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤..."
MACHINES=$(curl -s -X GET "$API_URL/machines/availability" | jq -r '.[] | select(.isAvailable == true) | .id' | head -1)
MACHINE_ID=$MACHINES
echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–æ–∫ ID: $MACHINE_ID"
echo ""

# 3. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
echo "üìã 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π..."
OPERATIONS=$(curl -s -X GET "$API_URL/operations" | jq -r '.[] | select(.status == "PENDING" or .status == "READY") | .id' | head -1)
OPERATION_ID=$OPERATIONS
echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é ID: $OPERATION_ID"
echo ""

if [ -z "$MACHINE_ID" ] || [ -z "$OPERATION_ID" ]; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞–Ω–∫–∏ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å:"
    echo "   - –°—Ç–∞–Ω–∫–∏ —Å isAvailable=true"
    echo "   - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PENDING –∏–ª–∏ READY"
    exit 1
fi

# 4. –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π (–ù–û–í–´–ô –ú–ï–¢–û–î)
echo "üéØ 4. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π..."
ASSIGN_RESULT=$(curl -s -X POST "$API_URL/planning/assign-operation" \
    -H "Content-Type: application/json" \
    -d "{\"operationId\": $OPERATION_ID, \"machineId\": $MACHINE_ID}")

echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:"
echo "$ASSIGN_RESULT" | jq '.'
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
echo "üìä 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏..."
sleep 2
SYNC_STATUS=$(curl -s -X GET "$API_URL/planning/sync-status/$OPERATION_ID")
echo "–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:"
echo "$SYNC_STATUS" | jq '.'
echo ""

# 6. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å–º–µ–Ω—ã (–∏–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –º–æ–¥—É–ª—è –°–º–µ–Ω—ã)
echo "üî® 6. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ —Å–º–µ–Ω—ã (–∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã)..."
TODAY=$(date +%Y-%m-%d)

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–º–µ–Ω –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏
SHIFTS=$(curl -s -X GET "$API_URL/shifts?operationId=$OPERATION_ID")
echo "–¢–µ–∫—É—â–∏–µ —Å–º–µ–Ω—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏:"
echo "$SHIFTS" | jq '.'
echo ""

# 7. –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (–∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–º–µ–Ω—ã)
echo "üìà 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–º–∞ (–¥–µ–Ω—å: 10, –Ω–æ—á—å: 15)..."

# –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å —Å–º–µ–Ω—ã —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –æ–±—ä–µ–º–æ–º
SHIFT_UPDATE=$(curl -s -X POST "$API_URL/shifts" \
    -H "Content-Type: application/json" \
    -d "{
        \"date\": \"$TODAY\",
        \"operationId\": $OPERATION_ID,
        \"machineId\": $MACHINE_ID,
        \"dayShiftQuantity\": 10,
        \"nightShiftQuantity\": 15,
        \"dayShiftOperator\": \"–¢–µ—Å—Ç –û–ø–µ—Ä–∞—Ç–æ—Ä –î–µ–Ω—å\",
        \"nightShiftOperator\": \"–¢–µ—Å—Ç –û–ø–µ—Ä–∞—Ç–æ—Ä –ù–æ—á—å\"
    }")

echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω—ã:"
echo "$SHIFT_UPDATE" | jq '.'
echo ""

# 8. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
echo "üîÑ 8. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö..."
sleep 1
SYNC_ALL=$(curl -s -X POST "$API_URL/sync/sync-all")
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:"
echo "$SYNC_ALL" | jq '.'
echo ""

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
echo "üìä 9. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
FINAL_STATUS=$(curl -s -X GET "$API_URL/planning/sync-status/$OPERATION_ID")
echo "–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:"
echo "$FINAL_STATUS" | jq '.'
echo ""

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞
echo "üîß 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞–Ω–∫–∞..."
MACHINE_STATUS=$(curl -s -X GET "$API_URL/machines/availability" | jq ".[] | select(.id == \"$MACHINE_ID\")")
echo "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞:"
echo "$MACHINE_STATUS" | jq '.'
echo ""

echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "   - –û–ø–µ—Ä–∞—Ü–∏—è $OPERATION_ID –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ —Å—Ç–∞–Ω–æ–∫ $MACHINE_ID"
echo "   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å–º–µ–Ω—ã"
echo "   - –ó–∞–ø–∏—Å–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–º: –î–µ–Ω—å 10 + –ù–æ—á—å 15 = 25 –¥–µ—Ç–∞–ª–µ–π"
echo "   - –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ Production –∏ Shifts"
echo ""
echo "üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
