@echo off
echo ================================================
echo ПОЛНОЕ ИСПРАВЛЕНИЕ ПЛАНИРОВАНИЯ - ФИНАЛЬНАЯ ВЕРСИЯ
echo ================================================

echo.
echo ✅ ИСПРАВЛЕНИЯ ПРИМЕНЕНЫ:
echo [✓] 1. Backend логика планирования - добавлены детальные логи
echo [✓] 2. Освобождены занятые станки (ID: 3, 5, 6, 7)
echo [✓] 3. Улучшена логика сопоставления операций и станков
echo [✓] 4. Исправлен демо-режим планирования

echo.
echo ⚠️  ТРЕБУЕТ РУЧНОГО ИСПРАВЛЕНИЯ:
echo [!] JSX ошибка: ^</r^> должно быть ^</r^>

echo.
echo ================================================
echo ЗАПУСК С ИСПРАВЛЕНИЯМИ
echo ================================================

echo.
echo 1. Компиляция backend с улучшенными логами...
cd /d "C:\Users\kasuf\Downloads\TheWho\production-crm\backend"
call npm run build
if %ERRORLEVEL% neq 0 (
    echo ❌ ОШИБКА: Backend компиляция не удалась!
    pause
    exit /b 1
)

echo.
echo 2. Запуск backend...
taskkill /f /im node.exe >nul 2>&1
timeout /t 2 >nul
start "Backend Server (FIXED)" cmd /k "npm run start:prod"
timeout /t 5

echo.
echo 3. Тестирование демо планирования...
echo.
curl -X POST "http://localhost:3001/api/planning/demo" -H "Content-Type: application/json"

echo.
echo.
echo ================================================
echo АНАЛИЗ ЛОГОВ
echo ================================================
echo.
echo В окне Backend Server ищите логи:
echo.
echo ✅ УСПЕШНО:
echo - "Найдено X заказов с приоритетами"
echo - "Найдено X первых операций" 
echo - "Найдено X доступных станков"
echo - "Сопоставлено X операций из Y"
echo.
echo ❌ ПРОБЛЕМЫ:
echo - "НЕ НАЙДЕНО совместимых станков"
echo - "КРИТИЧЕСКАЯ ОШИБКА: НЕ СОПОСТАВЛЕНО НИ ОДНОЙ ОПЕРАЦИИ"
echo.
echo Детальные логи покажут точную причину проблемы!
echo.
echo ================================================
echo ОЖИДАЕМЫЙ РЕЗУЛЬТАТ:
echo ================================================
echo.
echo Планирование должно найти:
echo 1. Заказ 8 (приоритет 1) → операция 20 (MILLING, 3 оси) → станок Mitsubishi или Doosan 3
echo 2. Заказ 7 (приоритет 2) → операция 1 (MILLING, 3 оси) → станок Mitsubishi или Doosan 3  
echo 3. Заказ 13 (приоритет 3) → операция 4 (DRILLING, 3 оси) → станок Mitsubishi или Doosan 3
echo.
echo И построить очередь из 3 операций!
echo.
echo ================================================
pause
