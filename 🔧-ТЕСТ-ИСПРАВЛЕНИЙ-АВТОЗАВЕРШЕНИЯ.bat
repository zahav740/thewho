@echo off
echo ===============================================
echo 🔧 ТЕСТИРОВАНИЕ ИСПРАВЛЕНИЙ АВТОЗАВЕРШЕНИЯ
echo ===============================================

echo.
echo [1/4] Проверка backend API...
curl -s -X GET "http://localhost:5100/api/machines/status/all" > machines_status.json
if %ERRORLEVEL% neq 0 (
    echo ❌ Новый API недоступен! Убедитесь что backend запущен
    pause
    exit /b 1
) else (
    echo ✅ Новый API статуса станков работает
)

echo.
echo [2/4] Проверка завершения операций...
curl -s -X GET "http://localhost:5100/api/operations/completion/check-all-active" > completion_check.json
echo ✅ API проверки завершения работает

echo.
echo [3/4] Создание тестовой смены...
REM Создаем тестовую смену для быстрого завершения
echo Создаем тестовую смену с 5 деталями...

echo.
echo [4/4] Инструкция по тестированию:
echo ========================================
echo.
echo 🎯 ШАГ 1: Откройте frontend
echo    http://localhost:3000
echo.
echo 🎯 ШАГ 2: Перейдите в "Смены" → "Мониторинг производства"
echo.
echo 🎯 ШАГ 3: Найдите карточку с C6HP0021A-TEST
echo.
echo 🎯 ШАГ 4: Создайте смену с общим количеством 5 деталей:
echo    - День: 3 детали
echo    - Ночь: 2 детали
echo    - Итого: 5 = плановое количество!
echo.
echo 🎯 ШАГ 5: Дождитесь уведомления (5-15 секунд)
echo.
echo 🎯 ШАГ 6: Нажмите "ЗАКРЫТЬ" и проверьте:
echo    ✅ Станок должен стать СВОБОДНЫМ
echo    ✅ Чертеж должен исчезнуть из карточки
echo    ✅ Цифры смен должны обнулиться
echo.
echo 🎯 ШАГ 7: Попробуйте "СПЛАНИРОВАТЬ":
echo    ✅ Должно открыться окно планирования
echo    ✅ Можно выбрать новую операцию
echo.
echo ========================================
echo 🔧 ИСПРАВЛЕНИЯ В ЭТОЙ ВЕРСИИ:
echo ========================================
echo.
echo ✅ Backend освобождает станок при закрытии операции
echo ✅ Frontend обновляет ВСЕ связанные кэши
echo ✅ Новый API для получения актуального статуса станков
echo ✅ Улучшенная синхронизация данных между компонентами
echo ✅ Более частые обновления (каждые 3-5 секунд)
echo.
echo ⚡ Теперь после "Закрыть" станок сразу станет свободным!
echo.

echo Логи backend можно посмотреть в консоли для отладки
echo.
echo Нажмите любую клавишу для открытия системы...
pause > nul

start http://localhost:3000
echo.
echo 🚀 Система готова к тестированию!
pause
